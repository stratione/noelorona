---
import BaseLayout from "../layouts/BaseLayout.astro";
import { SITE } from "../consts";
import { profile } from "../data/profile";
import { publications } from "../data/publications";

const siteUrl = Astro.site ?? new URL(SITE.siteUrl);

const publicationEntries = publications.map((item, index) => ({
  "@type": "ScholarlyArticle",
  "@id": `#publication-${index + 1}`,
  name: item.title,
  author: {
    "@type": "Person",
    name: profile.name
  },
  url: item.externalUrl ?? item.link
}));

const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Person",
      "@id": "#person",
      name: profile.name,
      url: siteUrl.href,
      sameAs: [profile.publications.scholarUrl]
    },
    ...publicationEntries
  ]
};

const timeline = publications;
---
<BaseLayout
  title="Publications"
  description="Selected publications and scholarly contributions for Dr. Noe Lorona."
  structuredData={structuredData}
>

    <div class="space-y-6">
      <section class="rounded-2xl border border-slate/10 bg-haze/80 p-6">
        <div class="mt-4 space-y-6">
          {timeline.map((publication) => (
            <article class="rounded-xl border border-slate/20 p-4">
              <h4 class="text-base font-semibold text-ink">{publication.title}</h4>
              {publication.externalUrl && (
                <details class="mt-3 rounded-lg border border-slate/20 bg-parchment/5 p-3">
                  <summary class="inline-flex cursor-pointer items-center rounded-full border border-slate/30 px-3 py-1 text-sm font-semibold text-marigold transition hover:border-marigold/60 whitespace-nowrap">
                    Go to episode
                  </summary>
                  <div class="mt-3 space-y-2">
                    <a class="text-sm text-slate underline" href={publication.externalUrl}>
                      {publication.externalUrl}
                    </a>
                    <iframe
                      class="h-64 w-full rounded-lg border border-slate/20"
                      src={publication.externalUrl}
                      title={`${publication.title} source`}
                      loading="lazy"
                    ></iframe>
                    <p class="text-xs text-slate">
                      If the embed is blocked, open the link in a new tab.
                    </p>
                  </div>
                </details>
              )}
              {publication.summary && (
                <p class="mt-2 text-sm text-slate">{publication.summary}</p>
              )}
              {publication.pdfUrl ? (
                <div class="mt-4 flex flex-wrap items-start gap-3 text-sm">
                  <details class="rounded-lg border border-slate/20 bg-parchment/5 px-3 py-2">
                    <summary class="inline-flex cursor-pointer items-center rounded-full border border-slate/30 px-3 py-1 font-semibold text-marigold transition hover:border-marigold/60 whitespace-nowrap">
                      Go to publication
                    </summary>
                    <div class="mt-3">
                      <object
                        data={publication.pdfUrl}
                        type="application/pdf"
                        class="h-64 w-full rounded-lg border border-slate/20"
                      >
                        <p class="text-sm text-slate">
                          PDF preview unavailable.
                          <a class="text-marigold" href={publication.pdfUrl}>
                            Open PDF
                          </a>
                        </p>
                      </object>
                    </div>
                  </details>
                  <a
                    class="inline-flex items-center rounded-full border border-slate/30 px-3 py-1 font-semibold text-marigold transition hover:border-marigold/60"
                    href={publication.pdfUrl}
                    download
                  >
                    Download publication
                  </a>
                </div>
              ) : null}
            </article>
          ))}
        </div>
      </section>
    </div>
  </section>
</BaseLayout>
